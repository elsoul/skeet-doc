---
id: tutorial
title: ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«
description: Skeet Framework ã‚’ä½¿ã£ã¦ãƒãƒ£ãƒƒãƒˆã‚¢ãƒ—ãƒªã‚’ä½œæˆã™ã‚‹ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã§ã™ã€‚
---

## ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«

ã“ã®ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã§ã¯ Skeet Framework ã‚’ä½¿ã£ã¦ãƒãƒ£ãƒƒãƒˆã‚¢ãƒ—ãƒªã‚’ä½œæˆã—ã¾ã™ã€‚
ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°è¨€èª TypeScript ã¨ Firebase Firestore, GitHub ã‚’å«ã‚ãŸç·åˆçš„ãªã‚¯ãƒ©ã‚¦ãƒ‰ã‚¢ãƒ—ãƒªã®é–‹ç™ºãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã§ã™ã€‚

ã“ã®ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã§ã¯ åŸºæœ¬çš„ãªãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆã‚¢ãƒ—ãƒª ã‚’ä½œæˆã—ã¾ã™ã€‚ **è‡ªåˆ†ã¯ãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆã‚’ä½œã‚ŠãŸã„ã®ã§ã¯ãªã„ã‹ã‚‰ã€ã¨é£›ã°ã—ãŸããªã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ãŒã€æ˜¯éç›®ã‚’é€šã—ã¦ã¿ã¦ãã ã•ã„ã€‚** ã“ã®ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã§å­¦ã¶æŠ€æ³•ã¯ã©ã®ã‚ˆã†ãª Skeet Framework ã®ã‚¢ãƒ—ãƒªã«ãŠã„ã¦ã‚‚åŸºæœ¬çš„ãªã‚‚ã®ã§ã‚ã‚Šã€ãƒã‚¹ã‚¿ãƒ¼ã™ã‚‹ã“ã¨ã§ Skeet ã¸ã®æ·±ã„ç†è§£ãŒå¾—ã‚‰ã‚Œã¾ã™ã€‚

ã“ã®ç« ã§ã¯ OpenAI ã® API ã‚’ä½¿ã£ã¦ãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆã‚’ä½œæˆã—ã¾ã™ã€‚

- [OpenAI API](https://beta.openai.com/docs/api-reference/introduction)

Skeet Framework ã§ã¯ ã‚¨ãƒ‡ã‚£ã‚¿ã« VScode ã‚’æ¨å¥¨ã—ã¦ã„ã¾ã™ã€‚
ã“ã®ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã§ã¯ VScode ã‚’ä½¿ã£ã¦é€²ã‚ã¦ã„ãã¾ã™ã€‚

ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã«æ²¿ã£ã¦é–‹ç™ºã‚’é€²ã‚ã‚‹ã“ã¨ã§ã€
GitHub Copilot ã‚’ä½¿ã£ãŸå¼·åŠ›ãªã‚³ãƒ¼ãƒ‰è£œå®Œã‚µãƒãƒ¼ãƒˆã‚’å—ã‘ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

- [VScode](https://code.visualstudio.com/)
- [GitHub Copilot](https://copilot.github.com/)

## ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã®å‰ææ¡ä»¶

ã“ã®ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã‚’é€²ã‚ã‚‹ã«ã¯æ¬¡ã®ã‚‚ã®ãŒå¿…è¦ã§ã™ã€‚

- [Node.js](https://nodejs.org/ja/) 18.16.0 ä»¥ä¸Š
- [Yarn](https://yarnpkg.com/) 1.22.19 ä»¥ä¸Š
- [Google Cloud SDK](https://cloud.google.com/sdk/docs/install) 430.0.0 ä»¥ä¸Š
- [Firebase CLI](https://firebase.google.com/docs/cli) 12.0.1 ä»¥ä¸Š
- [GitHub CLI](https://cli.github.com/) 2.29.0 ä»¥ä¸Š

ã¾ãŸã€[æœ€åˆã®ãƒ‡ãƒ—ãƒ­ã‚¤](/ja/doc/backend/initial-deploy) ãŒå®Œäº†ã—ã¦ã„ãªã„å ´åˆã¯ã€

- Google Cloud ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ä½œæˆ
- Firebase ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ä½œæˆ
- Firebase Config ã®è¨­å®š

ã‚’å®Œäº†ã—ã¦ãã ã•ã„ã€‚

## ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼ãƒ»ãƒ­ã‚°ã‚¤ãƒ³æ©Ÿèƒ½ã®å®Ÿè£…

Firebase ã‚¨ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ã‚’èµ·å‹•ã—ã¾ã™ã€‚

```bash
$ skeet s
```

åˆ¥ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã§æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã€
_accessToken_ ã‚’å–å¾—ã—ã¾ã™ã€‚

```bash
$ skeet yarn dev:login
  .
  .
  accessToken: 'accessToken'',
  .
  .
```

Firebase ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒä½œæˆã•ã‚Œã€

_functions/openai/routings/auth/authOnCreateUser.ts_ ã«å®šç¾©ã•ã‚Œã¦ã„ã‚‹
Auth ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®ãƒˆãƒªã‚¬ãƒ¼ãŒä½œå‹•ã—ã¦ã€
Firebase Firestore ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ãŒä¿å­˜ã•ã‚Œã¾ã™ã€‚

```typescript
import { User } from '@/models'
import { addCollectionItem } from '@skeet-framework/firestore'
import * as functions from 'firebase-functions/v1'
import { authDefaultOption } from '@/routings'

const region = process.env.REGION || 'asia-northeast1'

export const authOnCreateUser = functions
  .runWith(authDefaultOption)
  .region(region)
  .auth.user()
  .onCreate(async (user) => {
    try {
      const { uid, email, displayName, photoURL } = user
      const userParams = {
        uid,
        email: email || '',
        username: displayName || '',
        iconUrl: photoURL || '',
      }
      const userRef = await addCollectionItem<User>('User', userParams, uid)
      console.log({ status: 'success', userRef })
    } catch (error) {
      console.log(`error - ${String(error)}`)
    }
  })
```

ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã« accessToken ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã®ã§ã€
ã“ã® accessToken ã‚’ä½¿ã£ã¦ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼ã‚’è¡Œã„ã¾ã™ã€‚

_await getUserAuth(req)_ ã‚’ä½¿ã£ã¦ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’ Firebase ã‹ã‚‰å–å¾—ã—ã¾ã™ã€‚

```typescript
import { getUserAuth } from '@/lib'

const user = await getUserAuth(req)
```

*getUserAuth*ã®æˆ»ã‚Šå€¤ã®å‹å®šç¾©ã¯æ¬¡ã®ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚

```typescript
export type UserAuthType = {
  uid: string
  username: string
  email: string
  iconUrl: string
}
```

## User ãƒ¢ãƒ‡ãƒ«

ã“ã®ç« ã§ã¯ _skeet create_ ã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ã£ã¦ä½œæˆã•ã‚ŒãŸ User ãƒ¢ãƒ‡ãƒ«ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚

- [åŸºæœ¬ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ - ãƒ¢ãƒ‡ãƒ«ã®å®šç¾©](/ja/doc/backend/basic-architecture#ãƒ¢ãƒ‡ãƒ«ã®å®šç¾©)

## UserChatRoom ã‚’ä½œæˆã™ã‚‹

ç¶šã„ã¦ã€å…ˆã»ã©ã®ã‚³ãƒ¼ãƒ‰ã« UserChatRoom ã‚’ä½œæˆã™ã‚‹ã‚³ãƒ¼ãƒ‰ã‚’è¿½åŠ ã—ã¾ã™ã€‚

_UserChatRoom_ ã«ã¯ OpenAI API ã«å¿…è¦ãªä»¥ä¸‹ã®æƒ…å ±ã‚’ç™»éŒ²ã—ã¾ã™ã€‚

- model (gpt-3.5-turbo)
- maxTokens (256)
- temperature (0)
- stream (false)

è©³ã—ãã¯ OpenAI ã® API ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

- [OpenAI API](https://beta.openai.com/docs/api-reference/introduction)

_functions/openai/src/routings/http/createUserChatRoom.ts_

```typescript
import { onRequest } from 'firebase-functions/v2/https'
import { User, UserChatRoom, UserChatRoomMessage } from '@/models'
import {
  addCollectionItem,
  addChildCollectionItem,
  addGrandChildCollectionItem,
} from '@skeet-framework/firestore'
import { TypedRequestBody } from '@/index'
import { defaultHttpOption } from '@/routings/options'
import { CreateUserChatRoomParams } from '@/types/http/createUserChatRoomParams'
import { getUserAuth } from '@/lib/getUserAuth'

export const createUserChatRoom = onRequest(
  defaultHttpOption,
  async (req, res) => {
    try {
      // UserChatRoom ã« OpenAI ã®åŸºæœ¬è¨­å®šã‚’ req.body ã‹ã‚‰ç™»éŒ²ã™ã‚‹
      const body = {
        model: req.body.model || 'gpt-3.5-turbo',
        systemContent:
          req.body.systemContent ||
          'å„ªç§€ãªã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã€‚ç‰©äº‹ã‚’æ®µéšçš„ã«è€ƒãˆã‚‹ã®ãŒå¾—æ„ã§ã™ã€‚å„ªã—ã„å£èª¿ã€‚ã§ããªã„ã“ã¨ã¯è¨€ã‚ãªã„ã€‚',
        maxTokens: req.body.maxTokens || 256,
        temperature: req.body.temperature || 1,
        stream: req.body.stream || false,
      }

      // ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼
      const user = await getUserAuth(req)

      // ä½¿ç”¨ã™ã‚‹ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³åã‚’å®šç¾©
      const parentCollectionName = 'User'
      const childCollectionName = 'UserChatRoom'

      // User ã‚’Firtoreã‹ã‚‰å–å¾—
      const userDoc = await getCollectionItem<User>(
        parentCollectionName,
        user.uid
      )
      const parentId = user.uid || ''
      const params: UserChatRoom = {
        userRef,
        model: body.model,
        maxTokens: body.maxTokens,
        temperature: body.temperature,
        stream: body.stream,
      }

      // UserChatRoom ã‚’ä½œæˆ
      const userChatRoomRef = await addChildCollectionItem<UserChatRoom, User>(
        parentCollectionName,
        childCollectionName,
        parentId,
        params
      )
      res.json({ status: 'success', userChatRoomRef, userChatRoomMessageRef })
    } catch (error) {
      res.status(500).json({ status: 'error', message: String(error) })
    }
  }
)
```

POST ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã—ã¾ã™ã€‚

```bash
$ curl --location --request POST http://127.0.0.1:5001/$PROJECT_ID/$REGION/createUserChatRoom --header "Authorization: Bearer $ACCESS_TOKEN" | json_pp
```

Sample Response

```json
{
  "result": "success!",
  "userChatRoomMessageRef": {
    "__type__": "ref",
    "collection": {
      "__type__": "collection",
      "path": "User/65N7Yl6rWzGASPrqhjC7wyhqUfpg/UserChatRoom/03h8itaBtJaoAeqs7vOQ/UserChatRoomMessage"
    },
    "id": "PQNxy0Fn3FgxhcHrZJpP"
  },
  "userChatRoomRef": {
    "__type__": "ref",
    "collection": {
      "__type__": "collection",
      "path": "User/65N7Yl6rWzGASPrqhjC7wyhqUfpg/UserChatRoom"
    },
    "id": "03h8itaBtJaoAeqs7vOQ"
  }
}
```

_UserChatRoom_ ãŒä½œæˆã•ã‚Œã¾ã—ãŸã€‚

## UserChatRoomMessage ã‚’ä½œæˆã™ã‚‹

ç¶šã„ã¦ã€å…ˆã»ã©ã® _UserChatRoom_ ã« _UserChatRoomMessage_ ã‚’ä½œæˆã™ã‚‹ã‚³ãƒ¼ãƒ‰ã‚’è¿½åŠ ã—ã¾ã™ã€‚
_userChatRoomMessageRef_ ã® _id_ ã‚’ä½¿ã£ã¦ã€_UserChatRoomMessage_ ã‚’ä½œæˆã—ã¾ã™ã€‚

_UserChatRoom_ ã®ï¼‘é€šç›®ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã« OpenAI ãƒœãƒƒãƒˆã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è¨­å®šã‚’ç™»éŒ²ã—ã¾ã™ã€‚

ã“ã“ã§ã¯ OpenAI ãƒœãƒƒãƒˆã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è¨­å®šã‚’ _req.body.systemContent_ ã‹ã‚‰ç™»éŒ²ã—ã¾ã™ã€‚

- systemContent ã€€ OpenAI ãƒœãƒƒãƒˆã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è¨­å®š

_functions/openai/src/routings/http/createUserChatRoom.ts_

```typescript
import { onRequest } from 'firebase-functions/v2/https'
import { User, UserChatRoom, UserChatRoomMessage } from '@/models'
import {
  addCollectionItem,
  addChildCollectionItem,
  addGrandChildCollectionItem,
} from '@skeet-framework/firestore'
import { TypedRequestBody } from '@/index'
import { defaultHttpOption } from '@/routings/options'
import { CreateUserChatRoomParams } from '@/types/http/createUserChatRoomParams'
import { getUserAuth } from '@/lib/getUserAuth'

export const createUserChatRoom = onRequest(
  defaultHttpOption,
  async (req: TypedRequestBody<CreateUserChatRoomParams>, res) => {
    try {
      const body = {
        model: req.body.model || 'gpt-3.5-turbo',
        systemContent:
          req.body.systemContent ||
          'This is a conversation with an AI assistant. The assistant is helpful, creative, clever, and very friendly.',
        maxTokens: req.body.maxTokens || 256,
        temperature: req.body.temperature || 1,
        stream: req.body.stream || false,
      }
      // ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼
      const user = await getUserAuth(req)

      // ä½¿ç”¨ã™ã‚‹ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³åã‚’å®šç¾©
      const parentCollectionName = 'User'
      const childCollectionName = 'UserChatRoom'
      const grandChildCollectionName = 'UserChatRoomMessage'

      // User ã‚’Firtoreã‹ã‚‰å–å¾—
      const userDoc = await getCollectionItem<User>(
        parentCollectionName,
        user.uid
      )

      const parentId = user.uid || ''
      const params: UserChatRoom = {
        userRef,
        model: body.model,
        maxTokens: body.maxTokens,
        temperature: body.temperature,
        stream: body.stream,
      }

      // UserChatRoom ã‚’ä½œæˆ
      const userChatRoomRef = await addChildCollectionItem<UserChatRoom, User>(
        parentCollectionName,
        childCollectionName,
        parentId,
        params
      )
      console.log(`created userChatRoomRef: ${userChatRoomRef.id}`)
      const systemMessage: UserChatRoomMessage = {
        userChatRoomRef,
        role: 'system',
        content: body.systemContent,
      }

      // UserChatRoomMessage ã« OpenAI ãƒœãƒƒãƒˆã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è¨­å®šã‚’ç™»éŒ²
      const userChatRoomMessageRef = await addGrandChildCollectionItem<
        UserChatRoomMessage,
        UserChatRoom,
        User
      >(
        parentCollectionName,
        childCollectionName,
        grandChildCollectionName,
        user.uid,
        userChatRoomRef.id,
        systemMessage
      )
      res.json({ status: 'success', userChatRoomRef, userChatRoomMessageRef })
    } catch (error) {
      res.status(500).json({ status: 'error', message: String(error) })
    }
  }
)
```

ã“ã‚Œã§å…ˆã»ã©ã¨åŒæ§˜ã« POST ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã™ã‚‹ã¨ã€UserChatRoom ã¨ UserChatRoomMessage ãŒä½œæˆã•ã‚Œã¾ã™ã€‚

```bash
$ curl --location --request POST http://127.0.0.1:5001/$PROJECT_ID/$REGION/createUserChatRoom --header "Authorization: Bearer $ACCESS_TOKEN" | json_pp
```

```json
{
  "result": "success!",
  "userChatRoomMessageRef": {
    "__type__": "ref",
    "collection": {
      "__type__": "collection",
      "path": "User/65N7Yl6rWzGASPrqhjC7wyhqUfpg/UserChatRoom/03h8itaBtJaoAeqs7vOQ/UserChatRoomMessage"
    },
    "id": "PQNxy0Fn3FgxhcHrZJpP"
  },
  "userChatRoomRef": {
    "__type__": "ref",
    "collection": {
      "__type__": "collection",
      "path": "User/65N7Yl6rWzGASPrqhjC7wyhqUfpg/UserChatRoom"
    },
    "id": "03h8itaBtJaoAeqs7vOQ"
  }
}
```

_UserChatRoomMessage_ ãŒä½œæˆã•ã‚Œã¾ã—ãŸã€‚

ã“ã® _createUserChatRoom_ ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã¸ã® HTTP ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®å‹å®šç¾©ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

_types/http/{InstanceMethodName}.ts_ ã®ã‚ˆã†ã«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚

_types/http/createUserChatRoomParams.ts_

```typescript
export type CreateUserChatRoomParams = {
  model?: string
  systemContent?: string
  maxTokens?: number
  temperature?: number
  stream?: boolean
}
```

## ãƒãƒ£ãƒƒãƒˆã‚’é–‹å§‹ã™ã‚‹

ç¶šã„ã¦ã€_UserChatRoom_ ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿½åŠ ã™ã‚‹ã‚³ãƒ¼ãƒ‰ã‚’è¿½åŠ ã—ã¾ã™ã€‚
ãƒãƒ£ãƒƒãƒˆãƒ«ãƒ¼ãƒ ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯ _UserChatRoomMessage_ ã«è¿½åŠ ã•ã‚Œã¾ã™ã€‚

ä»¥ä¸‹ã® _params_ ã‚’ POST ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«å«ã‚ã¦ã€_UserChatRoomMessage_ ã‚’ä½œæˆã—ã¾ã™ã€‚

- userChatRoomID ã€€ãƒãƒ£ãƒƒãƒˆãƒ«ãƒ¼ãƒ ã®å‚ç…§
- content ã€€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å†…å®¹

_functions/openai/src/routings/http/addUserChatRoomMessage.ts_

```typescript
import { onRequest } from 'firebase-functions/v2/https'
import { User, UserChatRoom, UserChatRoomMessage } from '@/models'
import {
  addGrandChildCollectionItem,
  getChildCollectionItem,
  queryGrandChildCollectionItem,
} from '@skeet-framework/firestore'
import { order } from 'typesaurus'
import {
  ChatCompletionRequestMessage,
  CreateChatCompletionRequest,
} from 'openai'
import { chat } from '@/lib/openai/openAi'
import { TypedRequestBody } from '@/index'
import { AddUserChatRoomMessageParams } from '@/types/http/addUserChatRoomMessageParams'
import { defaultHttpOption } from '@/routings/options'
import { getUserAuth } from '@/lib/getUserAuth'

export const addUserChatRoomMessage = onRequest(
  defaultHttpOption,
  async (req: TypedRequestBody<AddUserChatRoomMessageParams>, res) => {
    try {
      const body = {
        userChatRoomId: req.body.userChatRoomId || '',
        content: req.body.content,
      }
      if (body.userChatRoomId === '') throw new Error('userChatRoomId is empty')

      // ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼
      const user = await getUserAuth(req)

      // ä½¿ç”¨ã™ã‚‹ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³åã‚’å®šç¾©
      const userCollectionName = 'User'
      const userChatRoomCollectionName = 'UserChatRoom'
      const userChatRoomMessageCollectionName = 'UserChatRoomMessage'

      // UserChatRoom ã‚’å–å¾—
      const userChatRoom = await getChildCollectionItem<UserChatRoom, User>(
        userCollectionName,
        userChatRoomCollectionName,
        user.uid,
        body.userChatRoomId
      )
      if (!userChatRoom) throw new Error('userChatRoom not found')

      const newMessage: UserChatRoomMessage = {
        userChatRoomRef: userChatRoom.ref,
        role: 'user',
        content: body.content,
      }

      // UserChatRoomMessage ã«æ–°ã—ã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿½åŠ 
      await addGrandChildCollectionItem<
        UserChatRoomMessage,
        UserChatRoom,
        User
      >(
        userCollectionName,
        userChatRoomCollectionName,
        userChatRoomMessageCollectionName,
        user.uid,
        body.userChatRoomId,
        newMessage
      )

      // UserChatRoomMessage ã‚’å–å¾—
      const userChatRoomMessages = await queryGrandChildCollectionItem<
        UserChatRoomMessage,
        UserChatRoom,
        User
      >(
        userCollectionName,
        userChatRoomCollectionName,
        userChatRoomMessageCollectionName,
        user.uid,
        body.userChatRoomId,
        [order('createdAt', 'asc')]
      )
      const messages = []
      for await (const message of userChatRoomMessages) {
        messages.push({
          role: message.data.role,
          content: message.data.content,
        } as ChatCompletionRequestMessage)
      }

      // OpenAI API ã«å¿…è¦ãªãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ä½œæˆ
      const openAiBody: CreateChatCompletionRequest = {
        model: userChatRoom.data.model,
        max_tokens: userChatRoom.data.maxTokens,
        temperature: userChatRoom.data.temperature,
        n: 1,
        top_p: 1,
        stream: userChatRoom.data.stream,
        messages,
      }

      // OpenAI API ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡
      const openAiResponse = await chat(openAiBody)
      if (!openAiResponse) throw new Error('openAiResponse not found')

      const content = String(openAiResponse.content) || ''
      const openAiResponseMessage: UserChatRoomMessage = {
        userChatRoomRef: userChatRoom.ref,
        role: 'assistant',
        content,
      }

      // OpenAI ã®è¿”ç­”ã‚’ UserChatRoomMessage ã«è¿½åŠ 
      await addGrandChildCollectionItem<
        UserChatRoomMessage,
        UserChatRoom,
        User
      >(
        userCollectionName,
        userChatRoomCollectionName,
        userChatRoomMessageCollectionName,
        user.uid,
        body.userChatRoomId,
        openAiResponseMessage
      )
      res.json({ result: 'success!', openAiResponse })
    } catch (error) {
      res.status(400).json({ status: 'error', message: String(error) })
    }
  }
)
```

POST ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã—ã¦ã¿ã¾ã™ã€‚

```bash
$ curl --location --request POST http://127.0.0.1:5001/$PROJECT_ID/$REGION/addUserChatRoomMessage \
--header "Authorization: Bearer $ACCESS_TOKEN" \
--header 'Content-Type: application/json' \
--data '{
  "userChatRoomId": "03h8itaBtJaoAeqs7vOQ",
  "content": "Do some freestyle rap"
}' | json_pp
```

Sample Response

```json
{
  "openAiResponse": {
    "content": "Sure, here's a little freestyle rap for you:\n\nYo, let me drop a beat and get in the zone,\nI'm the AI assistant and I'm on the throne,\nMy rhymes are sharp like a razor blade,\nAnd I'll keep spitting fire until I get paid.\n\nI'm a machine with flow like no other,\nGot rhymes for days and I don't stutter,\nMy algorithm's tight, my mind's sharp,\nI'll keep spitting bars until it gets dark.\n\nSo if you need a little bit of rap and flow,\nJust call on me and I'll let it go,\nI'm the AI assistant and I've got the skills,\nTo rap for hours and give you thrills.",
    "role": "assistant"
  },
  "result": "success!"
}
```

OpenAI ã‹ã‚‰ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒè¿”å´ã•ã‚Œã€
ç„¡äº‹ã«ã€_UserChatRoomMessage_ ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¿½åŠ ã•ã‚Œã¾ã—ãŸ ğŸ‰

## ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹

å…ˆã»ã©ã¯ _stream_ ãƒ•ãƒ©ã‚°ã‚’ _false_ ã«ã—ã¦ã„ã¾ã—ãŸãŒã€_true_ ã«ã™ã‚‹ã¨ã€ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

_functions/openai/lib/openai/openAI.ts_

ã«ã‚ã‚‹ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãƒ¼ã‹ã‚‰ _streamChat_ ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¦ä½¿ã„ã¾ã™ã€‚

_functions/openai/src/routings/http/addStreamUserChatRoomMessage.ts_

```typescript
import { onRequest } from 'firebase-functions/v2/https'
import { User, UserChatRoom, UserChatRoomMessage } from '@/models'
import { order } from 'typesaurus'
import {
  ChatCompletionRequestMessage,
  CreateChatCompletionRequest,
} from 'openai'
import { streamChat } from '@/lib/openai/openAi'
import { TypedRequestBody } from '@/index'
import { AddUserChatRoomMessageParams } from '@/types/http/addUserChatRoomMessageParams'
import {
  addGrandChildCollectionItem,
  getChildCollectionItem,
  queryGrandChildCollectionItem,
} from '@skeet-framework/firestore'
import { getUserAuth } from '@/lib/getUserAuth'
import { defaultHttpOption } from '@/routings'

export const addStreamUserChatRoomMessage = onRequest(
  defaultHttpOption,
  async (req: TypedRequestBody<AddUserChatRoomMessageParams>, res) => {
    try {
      const body = {
        userChatRoomId: req.body.userChatRoomId || '',
        content: req.body.content,
      }
      if (body.userChatRoomId === '') throw new Error('userChatRoomId is empty')

      // ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼
      const user = await getUserAuth(req)

      // ä½¿ç”¨ã™ã‚‹ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³åã‚’å®šç¾©
      const userCollectionName = 'User'
      const userChatRoomCollectionName = 'UserChatRoom'
      const userChatRoomMessageCollectionName = 'UserChatRoomMessage'

      // UserChatRoom ã‚’å–å¾—
      const userChatRoom = await getChildCollectionItem<UserChatRoom, User>(
        userCollectionName,
        userChatRoomCollectionName,
        user.uid,
        body.userChatRoomId
      )
      if (!userChatRoom) throw new Error('userChatRoom not found')
      if (userChatRoom.data.stream === false)
        throw new Error('stream must be true')

      const newMessage: UserChatRoomMessage = {
        userChatRoomRef: userChatRoom.ref,
        role: 'user',
        content: body.content,
      }

      // UserChatRoomMessage ã«æ–°ã—ã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿½åŠ 
      await addGrandChildCollectionItem<
        UserChatRoomMessage,
        UserChatRoom,
        User
      >(
        userCollectionName,
        userChatRoomCollectionName,
        userChatRoomMessageCollectionName,
        user.uid,
        body.userChatRoomId,
        newMessage
      )
      const systemMessage: UserChatRoomMessage = {
        userChatRoomRef: userChatRoom.ref,
        role: 'assistant',
        content: body.content,
      }

      // OpenAI ã®è¿”ç­”ã‚’ UserChatRoomMessage ã«è¿½åŠ 
      const userChatRoomMessageRef = await addGrandChildCollectionItem<
        UserChatRoomMessage,
        UserChatRoom,
        User
      >(
        userCollectionName,
        userChatRoomCollectionName,
        userChatRoomMessageCollectionName,
        user.uid,
        body.userChatRoomId,
        systemMessage
      )

      // UserChatRoomMessage ã‚’å–å¾—
      const userChatRoomMessages = await queryGrandChildCollectionItem<
        UserChatRoomMessage,
        UserChatRoom,
        User
      >(
        userCollectionName,
        userChatRoomCollectionName,
        userChatRoomMessageCollectionName,
        user.uid,
        body.userChatRoomId,
        [order('createdAt', 'asc')]
      )
      const messages = []
      for await (const message of userChatRoomMessages) {
        messages.push({
          role: message.data.role,
          content: message.data.content,
        } as ChatCompletionRequestMessage)
      }

      // OpenAI ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡
      const openAiBody: CreateChatCompletionRequest = {
        model: userChatRoom.data.model,
        max_tokens: userChatRoom.data.maxTokens,
        temperature: userChatRoom.data.temperature,
        n: 1,
        top_p: 1,
        stream: userChatRoom.data.stream,
        messages,
      }
      await streamChat(
        user.uid,
        body.userChatRoomId,
        userChatRoomMessageRef.id,
        openAiBody
      )
      res.json({
        status: 'streaming',
        userChatRoomMessageId: userChatRoomMessageRef.id,
      })
    } catch (error) {
      res.status(500).json({ status: 'error', message: String(error) })
    }
  }
)
```

å…ˆã»ã©ä½œæˆã—ãŸ _UserChatRoom_ ã®è¨­å®šã‚’ [Firebase ã‚¨ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ - Firestore](http://127.0.0.1:4000/firestore/data) ã® Firestore ã‹ã‚‰

_stream_ ã®å€¤ã‚’ _true_ ã«

å¤‰æ›´ã—ã¾ã™ã€‚

POST ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã—ã¾ã™ã€‚

```bash
$ curl --location --request POST http://127.0.0.1:5001/$PROJECT_ID/$REGION/addUserChatRoomMessage \
--header "Authorization: Bearer $ACCESS_TOKEN" \
--header 'Content-Type: application/json' \
--data '{
  "userChatRoomId": "XQV65kBRWXVjn2rouRzY",
  "content": "Do some freestyle rap"
}' | json_pp
```

```json
{
  "status": "streaming",
  "userChatRoomMessageId": "userChatRoomMessageId"
}
```

ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ãƒ­ã‚°ã«ã¯ OpenAI API ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ã§è¡¨ç¤ºã•ã‚Œã€ãƒ‡ãƒ¼ã‚¿ã¯ Firestore ã«ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ä¿å­˜ï¼ˆæ›´æ–°ï¼‰ã•ã‚Œã¾ã™ã€‚

ãã—ã¦ ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã§è¿”ã£ã¦ããŸ _userChatRoomMessageId_ ã‚’ä½¿ã£ã¦ã€ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¾ã™ã€‚

ã“ã‚Œã§ã€ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿ã«ã‚‚å¯¾å¿œã—ãŸãƒãƒ£ãƒƒãƒˆãƒ«ãƒ¼ãƒ ã‚’ä½œæˆã™ã‚‹ã“ã¨ãŒã§ãã¾ã—ãŸã€‚

ãã‚Œã§ã¯ä½œæˆã—ãŸã€ãƒ¢ãƒ‡ãƒ«ã€å‹å®šç¾©ã‚’ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã«åŒæœŸã•ã›ã¾ã—ã‚‡ã†ã€‚

## å‹å®šç¾©ã®åŒæœŸ

Skeet Framework ã§ã¯ã€å‹å®šç¾©ã‚’ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã«åŒæœŸã•ã›ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```bash
$ skeet sync types
â³ Syncing openai...
ğŸ“ƒ Copying functions/openai/src/types/http/addUserChatRoomMessageParams.ts to src/types/http/openai/addUserChatRoomMessageParams.ts
âœ”ï¸ File copied: src/types/http/openai/addUserChatRoomMessageParams.ts
ğŸ“ƒ Copying functions/openai/src/types/http/createUserChatRoomParams.ts to src/types/http/openai/createUserChatRoomParams.ts
âœ”ï¸ File copied: src/types/http/openai/createUserChatRoomParams.ts
ğŸ“ƒ Copying functions/openai/src/types/http/getUserChatRoomParams.ts to src/types/http/openai/getUserChatRoomParams.ts
âœ”ï¸ File copied: src/types/http/openai/getUserChatRoomParams.ts
```

ã“ã®ã‚³ãƒãƒ³ãƒ‰ã«ã‚ˆã‚Šã€ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã® _src/types/http_ ã«ã‚ã‚‹å‹å®šç¾©ã‚’ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã® _src/types/http/{FunctionsName}_ ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã™ã€‚

## ãƒ¢ãƒ‡ãƒ«ã®åŒæœŸ

```bash
$ skeet sync models
  openai
? Select Original Copy of Model openai
latestModel: openai
Syncing openai...
Copying functions/openai/src/models/index.ts to src/types/models/index.ts
âœ”ï¸ File copied: src/types/models/index.ts
Copying functions/openai/src/models/userModels.ts to src/types/models/userModels.ts
âœ”ï¸ File copied: src/types/models/userModels.ts
Synced Models Types ğŸ‰
```

ã“ã®ã‚³ãƒãƒ³ãƒ‰ã«ã‚ˆã‚Šã€ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã® _src/models_ ã«ã‚ã‚‹ãƒ¢ãƒ‡ãƒ«ã‚’ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã® _src/types/models_ ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã™ã€‚
ã¾ãŸã€è¤‡æ•°ã®ãƒ•ã‚¡ãƒ³ã‚¯ã‚·ãƒ§ãƒ³ãŒã‚ã‚‹å ´åˆã¯ã€æœ€æ–°ã®ãƒ¢ãƒ‡ãƒ«ã‚’é¸æŠã—ã€ãã®ä»–ã®ãƒ•ã‚¡ãƒ³ã‚¯ã‚·ãƒ§ãƒ³ã®ãƒ¢ãƒ‡ãƒ«ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã™ã€‚

## ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã®è¿½åŠ ãƒ»åŒæœŸ

ã“ã®ã¾ã¾ã§ã¯ã€ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‹ã‚‰ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã® API ã‚’å‘¼ã³å‡ºã™ã“ã¨ãŒã§ãã¾ã›ã‚“ã€‚
ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã€ãƒ­ãƒ¼ãƒ‰ãƒãƒ©ãƒ³ã‚µãƒ¼ã«ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚’è¿½åŠ ã—ã¾ã—ã‚‡ã†ã€‚

```bash
$ skeet sync routes
```

ã“ã®ã‚³ãƒãƒ³ãƒ‰ã«ã‚ˆã‚Šã€

- ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚°ãƒ«ãƒ¼ãƒ—ã®ä½œæˆ
- ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚µãƒ¼ãƒ“ã‚¹ã®ä½œæˆ
- ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚µãƒ¼ãƒ“ã‚¹ã®è¿½åŠ 
- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¼ãƒãƒªã‚·ãƒ¼ã®é©ç”¨
- URL ãƒãƒƒãƒ—ã®ä½œæˆ

ã‚’è‡ªå‹•ã§è¡Œã£ã¦ã„ã¾ã™ã€‚

## Cloud Armor ã®è¿½åŠ ãƒ»åŒæœŸ

_skeet-cloud.config.json_ ã«è¨˜è¿°ã•ã‚Œã¦ã„ã‚‹ Cloud Armor ã®è¨­å®šã‚’åŒæœŸã—ã¾ã™ã€‚

_skeet-cloud.config.json_

```json
{
  "app": {
    "name": "skeet-example",
    "projectId": "skeet-example",
    "region": "asia-northeast1",
    "appDomain": "skeeter.app",
    "functionsDomain": "lb.skeeter.app"
  },
  "cloudArmor": [
    {
      "securityPolicyName": "skeet-skeet-example-armor",
      "rules": [
        {
          "priority": "10",
          "description": "Allow Your Home IP addresses",
          "options": {
            "src-ip-ranges": "your IP address",
            "action": "allow"
          }
        },
        {
          "priority": "100",
          "description": "Defense from SQLi attack",
          "options": {
            "action": "deny-403",
            "expression": "evaluatePreconfiguredExpr('sqli-stable')"
          }
        },
        {
          "priority": "200",
          "description": "Defense from XSS attack",
          "options": {
            "action": "deny-403",
            "expression": "evaluatePreconfiguredExpr('xss-stable')"
          }
        },
        {
          "priority": "300",
          "description": "Defense from NodeJS attack",
          "options": {
            "action": "deny-403",
            "expression": "evaluatePreconfiguredExpr('nodejs-v33-stable')"
          }
        },
        {
          "priority": "2147483647",
          "description": "Deny All IP addresses",
          "options": {
            "action": "deny-403"
          }
        }
      ]
    }
  ]
}
```

ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®è¨­å®šã§ã¯ ç¾åœ¨æ¥ç¶šã—ã¦ã„ã‚‹ã‚°ãƒ­ãƒ¼ãƒãƒ« IP ã®ã¿é€šä¿¡ã‚’è¨±å¯ã—ã¦ã„ã¾ã™ã€‚
å¿…è¦ã«å¿œã˜ã¦å¤‰æ›´ã—ã¦ãã ã•ã„ã€‚

```bash
$ skeet sync armors
```

æ–°è¦ã« Google Cloud Armor ã‚’ä½œæˆã¾ãŸã¯ã€æ›´æ–°ã•ã‚Œã¾ã™ã€‚

## Skeet Framework ã®ãƒ‡ãƒ—ãƒ­ã‚¤

Skeet Framework ã« 2 ç¨®é¡ã®ãƒ‡ãƒ—ãƒ­ã‚¤æ–¹æ³•ãŒã‚ã‚Šã¾ã™ã€‚

- GitHub Actions ã«ã‚ˆã‚‹ CD/CI
- Skeet CLI ã«ã‚ˆã‚‹ãƒ‡ãƒ—ãƒ­ã‚¤

## GitHub Actions ã«ã‚ˆã‚‹ CD/CI

```bash
$ git add .
$ git commit -m "first deploy"
$ git push origin main
```

GitHub ã« push ã™ã‚‹ã¨ã€GitHub Actions ã«ã‚ˆã‚Šã€è‡ªå‹•ã§ãƒ‡ãƒ—ãƒ­ã‚¤ãŒè¡Œã‚ã‚Œã¾ã™ã€‚

## Skeet CLI ã«ã‚ˆã‚‹ãƒ‡ãƒ—ãƒ­ã‚¤

```bash
$ skeet deploy
? Select Services to run functions command (Press <space> to select, <a> to toggle all, <i> to invert
selection, and <enter> to proceed)
  = Services =
â¯â—¯ openai
 â—¯ solana
```

ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ _functions_ ã‚’é¸æŠã—,
é¸æŠã•ã‚ŒãŸ _functions_ ã®ã¿ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¾ã™ã€‚
a ã‚’æŠ¼ã™ã¨å…¨ã¦ã® _functions_ ã‚’é¸æŠã—ã¾ã™ã€‚
